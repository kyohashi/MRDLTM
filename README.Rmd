---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# MRDLTM: Market-Response Dynamic Linear Topic Model

<!-- badges: start -->
[![R-CMD-check](https://github.com/kyohashi/MRDLTM/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/kyohashi/MRDLTM/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

MRDLTM is an R package for estimating marketing response coefficients and latent topic dynamics from ID-POS purchase data. It implements a Market-Response Dynamic Linear Topic Model using a Gibbs sampler with Polya-Gamma augmentation and other techniques.

## Installation
You can install the development version of MRDLTM from GitHub:
```{r, message = FALSE, warning = FALSE}
# install.packages("devtools")
devtools::install_github("kyohashi/MRDLTM")
```

## Quick Start: Synthetic Data Experiment
This example demonstrates how to generate synthetic data, run the MCMC engine, and visualize the results.

### 1. Data Generation
We generate a synthetic dataset with 30 customers, 5 items, and 3 latent topics across 24 time points.
```{r, message = FALSE, warning = FALSE}
library(MRDLTM)
library(bayesplot)
library(ggplot2)

set.seed(42)

# Generate synthetic observations and true parameters
toy = generate_toy_data(
  n_cust = 30, 
  n_item = 5, 
  n_topic = 3,
  length_time = 24, 
  n_var = 2, 
  p_dim = 1
)
```

### 2. Model Estimation
Initialize the model specification and run the Gibbs sampler.
```{r}
# Define model
model = mrdltm_model(observations = toy$observations, n_topic = 3)

# Run MCMC (2000 iterations with 1000 burn-in)
# Execution time is measured using system.time
iter = 1000
burnin = 500
timer = system.time({
  res = mrdltm_mcmc(model = model, iter = iter, burnin = burnin)
})

cat(sprintf("Total Elapsed Time: %.2f minutes\n", timer["elapsed"] / 60))
```

### 3. Diagnostics and Recovery
Check the convergence of the Log-Likelihood and the recovery of marketing response coefficients ($\beta$).
```{r, message = FALSE, warning = FALSE}
# Extract all samples to check convergence
log_lik_all = extract_samples(res, "log_lik", burnin = 0)
mcmc_trace(log_lik_all) +
  geom_vline(xintercept = burnin, color = "red", linetype = "dashed") +
  ggtitle("Log-Likelihood Trace")

# Extract post-burnin samples for parameter recovery
beta_post = extract_samples(res, "beta", burnin = burnin)
mcmc_intervals(beta_post, pars = vars(contains("i1")), prob = 0.95) +
  ggtitle("Posterior 95% Intervals for Beta (Item 1)")
```


